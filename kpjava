
import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.sql.*;

// === Database Helper ===
class Database {
    private static final String URL = "jdbc:sqlite:app.db";

    // Load JDBC driver and create table safely
    static {
        try {
            // Ensure SQLite JDBC driver is loaded
            Class.forName("org.sqlite.JDBC");

            try (Connection conn = connect()) {
                if (conn != null) {
                    try (Statement stmt = conn.createStatement()) {
                        String sql = """
                            CREATE TABLE IF NOT EXISTS users (
                                id INTEGER PRIMARY KEY AUTOINCREMENT,
                                name TEXT NOT NULL,
                                email TEXT UNIQUE NOT NULL
                            );
                        """;
                        stmt.execute(sql);
                        System.out.println("✅ Database initialized successfully.");
                    }
                } else {
                    System.err.println("❌ Could not establish SQLite connection.");
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static Connection connect() {
        try {
            return DriverManager.getConnection(URL);
        } catch (SQLException e) {
            System.err.println("❌ Connection failed: " + e.getMessage());
            return null;
        }
    }
}

// === DAO Layer ===
class UserDAO {
    public static void insertUser(String name, String email) {
        String sql = "INSERT INTO users(name, email) VALUES(?, ?)";
        try (Connection conn = Database.connect();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            pstmt.setString(1, name);
            pstmt.setString(2, email);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(null, "Insert failed: " + e.getMessage());
        }
    }

    public static ResultSet getAllUsers() {
        String sql = "SELECT * FROM users";
        try {
            Connection conn = Database.connect();
            if (conn == null) throw new SQLException("No database connection");
            Statement stmt = conn.createStatement();
            return stmt.executeQuery(sql);
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(null, "Load failed: " + e.getMessage());
            return null;
        }
    }
}

// === GUI Layer ===
public class UserApp extends JFrame {
    private JTextField txtName;
    private JTextField txtEmail;
    private JTable table;
    private DefaultTableModel model;

    public UserApp() {
        setTitle("User App");
        setSize(500, 400);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout());

        // --- Form Panel ---
        JPanel formPanel = new JPanel(new GridLayout(3, 2, 5, 5));
        formPanel.setBorder(BorderFactory.createEmptyBorder(10, 10, 10, 10));

        formPanel.add(new JLabel("Name:"));
        txtName = new JTextField();
        formPanel.add(txtName);

        formPanel.add(new JLabel("Email:"));
        txtEmail = new JTextField();
        formPanel.add(txtEmail);

        JButton btnAdd = new JButton("Add User");
        formPanel.add(btnAdd);

        JButton btnRefresh = new JButton("Refresh");
        formPanel.add(btnRefresh);

        add(formPanel, BorderLayout.NORTH);

        // --- Table ---
        model = new DefaultTableModel(new Object[]{"ID", "Name", "Email"}, 0);
        table = new JTable(model);
        add(new JScrollPane(table), BorderLayout.CENTER);

        // --- Button Actions ---
        btnAdd.addActionListener(e -> addUser());
        btnRefresh.addActionListener(e -> loadUsers());

        // Load initial data
        loadUsers();
    }

    private void addUser() {
        String name = txtName.getText().trim();
        String email = txtEmail.getText().trim();

        if (name.isEmpty() || email.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please fill all fields.");
            return;
        }

        UserDAO.insertUser(name, email);
        txtName.setText("");
        txtEmail.setText("");
        loadUsers();
    }

    private void loadUsers() {
        model.setRowCount(0); // clear table
        try (ResultSet rs = UserDAO.getAllUsers()) {
            if (rs != null) {
                while (rs.next()) {
                    model.addRow(new Object[]{
                            rs.getInt("id"),
                            rs.getString("name"),
                            rs.getString("email")
                    });
                }
            }
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Error loading users: " + e.getMessage());
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new UserApp().setVisible(true));
    }
}
